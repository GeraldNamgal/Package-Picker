{% extends "webservice/base.html" %}

{% load static %}

{% block title %}
    Recommendations
{% endblock %}

{% block body %}
    <section class="section">
        <div class="container">
            <div class="content is-medium">
                <h2>Package recommendations for {{ repository_name }}</h2>
                <p>
                    This tool recommends packages that frequently appear alongside the packages
                    in {{ repository_name }}. A score of 10 indicates that the packages are
                    <em>always</em> used together.
                </p>
                <p>Choose a branch:</p>
                <div class="dropdown is-hoverable">
                    <div class="dropdown-trigger">
                        <button class="button" aria-haspopup="true" aria-controls="dropdown-menu">
                            <span>{{ current_branch }}</span>
                            <span class="icon is-small">
                <i class="fas fa-angle-down" aria-hidden="true"></i>
              </span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu" role="menu">
                        <div class="dropdown-content">
                            {% for branch_name in branch_names %}

                                <a href="?branch={{ branch_name }}" class="dropdown-item">
                                    {{ branch_name }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <table>
                    <tr>
                        <td id="selected-category">Selected Category:</td>
                        <td id="selected-category-input"><input type="text" id="categoryName" name="categoryName"
                                                                disabled></td>
                        <td>
                            <button id="categoryClear" class="button is-light is-small" onclick="categoryClear()">
                                Clear
                            </button>
                        </td>
                    </tr>
                </table>
                <div class="recommendation-filter">
                    <p class="control has-icons-right">
                        <input id="recommendationFilter" class="input" type="text" placeholder="Search">
                        <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
                    </p>
                </div>
                <div class="table-container">
                    <table id="recommendTable" class="display-data-tables">
                        <thead>
                        <tr>
                            <th>Package</th>
                            <th>Recommendation</th>
                            <th>URL</th>
                            <th>PkgPkr Score</th>
                            <th>Absolute Trend</th>
                            <th>Relative Trend</th>
                            <th>Popularity</th>
                            <th>Similarity</th>
                            <th>Categories</th>
                            <th id="version-date-header">Version Date</th>
                        </tr>
                        </thead>
                        <tbody>
                            <!-- Rows are added dynamically -->
                        </tbody>
                    </table>
                    <div id="scoreModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                      <div class="modal-dialog" role="document">
                        <div class="modal-background"></div>
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                          </div>
                          <div class="modal-body">
                            <div class="insertHere"></div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script>
        $(document).ready(function() {
            var table = $('#recommendTable').DataTable({
                "bLengthChange": false,
                dom: 'tip',
                ajax: '{{ recommendation_url }}',
                scroller: true,
                order: [[3, "desc"]],
                columnDefs : [
                    // Render recommendation link
                    {
                        "targets": 1,
                        "render": function (data, type, row, meta) {
                            return '<a href="' + data[1] + '">' + row[1] + '</a>'
                        }
                    },
                    // Render PkgPkr Score
                    {
                        "targets": 3,
                        "render": function (data, type, row, meta) {
                            return '<img class="pkgpkrscore_img" src="/static/images/' + data + '.png"><p class="pkgpkrscore_value">' + data + '</p>'
                        }
                    },
                    // Render categories
                    {
                        "targets": 8,
                        "render": function (data, type, row, meta) {
                            if (!data) {
                                return "";
                            }

                            html_str = '<div class="buttons" style="margin-bottom: 0; display:inline-block;">';
                            for (var i = 0; i < data.length; ++i) {
                                html_str += '<button class="button is-info is-light is-small is-hovered" \
                                                     onclick="categoryClick(\'' + data[i] + '\')">' + data[i] + '</button>';
                            }
                            html_str += '</div>';
                            return html_str;
                        }
                    },
                    // Hide URL and component scores
                    {
                        "targets": [2, 4, 5, 6, 7],
                        "visible": false
                    }
                ]
            });

            $('#recommendTable tbody ').on('click', 'img', function() {
                var data = table.row($(this).parents('tr')).data();
                $('.insertHere').html(
                    '<table class="table dtr-details" width="100%"><tbody><tr><td>PkgPkr Score<td><td>' + data[2] +
                    '</td></tr><tr><td>Absolute Trend Score<td><td>' + data[3] +
                    '</td></tr><tr><td>Relative Trend Score<td><td>' + data[4] +
                    '</td></tr><tr><td>Popularity Score<td><td>' + data[5] +
                    '</td></tr><tr><td>Similarity Score<td><td>' + data[6] +
                    '</td></tr></tbody></table>'
                );
                $('#scoreModal').modal('show');
            });

            $('#categoryName').keyup(function() {
                table.column(7).search($(this).val()).draw();
            });

            $('#recommendationFilter').keyup(function() {
                table.search($(this).val()).draw();
            });
        });
    </script>
{% endblock %}
